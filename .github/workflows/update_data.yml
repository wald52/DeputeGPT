name: Mise à jour quotidienne des votes

on:
  schedule:
    # Se lance tous les jours à 4h00 du matin (UTC)
    - cron: '0 4 * * *'
  workflow_dispatch: # Permet de le lancer manuellement depuis l'interface GitHub pour tester

jobs:
  update-votes:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Important pour pouvoir commiter les changements

    steps:
      - name: Récupération du code
        uses: actions/checkout@v4

      - name: Installation de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Téléchargement des données de l'Assemblée
        run: |
          # Création du dossier temporaire
          mkdir -p Scrutins
          # Téléchargement du ZIP JSON officiel (Législature 17)
          wget -O Scrutins.json.zip "https://data.assemblee-nationale.fr/static/openData/repository/17/loi/scrutins/Scrutins.json.zip"
          # Décompression
          unzip Scrutins.json.zip -d Scrutins

      - name: Exécution du script de traitement
        run: |
          # On lance le script qui génère les petits JSONs dans public/data/votes/
          python scripts/process_votes.py

      - name: Sauvegarde des changements (Commit & Push)
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "bot@noreply.github.com"
          
          # Ajoute tous les nouveaux fichiers JSON
          git add public/data/votes/*.json
          
          # Vérifie s'il y a des changements avant de commiter
          if git diff --staged --quiet; then
            echo "Pas de nouveaux votes aujourd'hui."
          else
            git commit -m "data(votes): mise à jour automatique des scrutins"
            git push
          fi
